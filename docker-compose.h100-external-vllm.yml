# Docker Compose for H100 - Uses EXISTING vLLM container
# This connects to your already-running vllm-qwen3-32b container
#
# USAGE:
#   1. Start your vLLM container: docker start vllm-qwen3-32b
#   2. Run this compose: docker-compose -f docker-compose.h100-external-vllm.yml up -d
#   3. Create agents: curl -X POST http://localhost:8001/agents/population -H 'Content-Type: application/json' -d '{"count": 100}'
#   4. Start simulation: curl -X POST http://localhost:8001/simulation/start -H 'Content-Type: application/json' -d '{"ticks": 100}'

version: '3.8'

services:
  # ============================================
  # AI Agent Service (connects to external vLLM)
  # ============================================
  agent-service:
    build:
      context: ./services/agents
      dockerfile: Dockerfile
    ports:
      - "8001:8001"
    environment:
      - GATEWAY_URL=http://gateway:8000
      - LLM_PROVIDER=vllm
      # Connect to host's vLLM container (running outside docker-compose)
      - LLM_BASE_URL=http://host.docker.internal:8000
      - LLM_MODEL=qwen3-32b
      # H100 can handle larger batches with vLLM continuous batching
      - BATCH_SIZE=25
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - simulation-data:/app/simulation_data
      - ./research_data:/app/research_data
    depends_on:
      - gateway
    networks:
      - capitalism-net

  # ============================================
  # Gateway & Backend Services
  # ============================================
  frontend:
    build: ./frontend
    ports:
      - "3000:80"
    depends_on:
      - gateway
    networks:
      - capitalism-net

  gateway:
    build: ./gateway
    ports:
      - "8080:8000"  # Changed to 8080 since vLLM uses 8000
    depends_on:
      - redis
      - marketplace-1
      - marketplace-2
      - marketplace-3
      - discourse-1
      - discourse-2
      - discourse-3
    environment:
      - MARKETPLACE_REPLICAS=marketplace-1:3001,marketplace-2:3002,marketplace-3:3003
      - DISCOURSE_REPLICAS=discourse-1:4001,discourse-2:4002,discourse-3:4003
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=capitalism-simulation-secret-key-2025
      - CACHE_TTL=60
    networks:
      - capitalism-net

  marketplace-1:
    build: ./services/marketplace
    environment:
      - PORT=3001
      - MONGODB_URI=mongodb://mongo-marketplace:27017/marketplace
      - INSTANCE_ID=marketplace-1
    depends_on:
      - mongo-marketplace
    networks:
      - capitalism-net

  marketplace-2:
    build: ./services/marketplace
    environment:
      - PORT=3002
      - MONGODB_URI=mongodb://mongo-marketplace:27017/marketplace
      - INSTANCE_ID=marketplace-2
    depends_on:
      - mongo-marketplace
    networks:
      - capitalism-net

  marketplace-3:
    build: ./services/marketplace
    environment:
      - PORT=3003
      - MONGODB_URI=mongodb://mongo-marketplace:27017/marketplace
      - INSTANCE_ID=marketplace-3
    depends_on:
      - mongo-marketplace
    networks:
      - capitalism-net

  discourse-1:
    build: ./services/discourse
    environment:
      - PORT=4001
      - DATABASE_URL=postgres://postgres:password@postgres-discourse:5432/discourse
      - INSTANCE_ID=discourse-1
    depends_on:
      - postgres-discourse
    networks:
      - capitalism-net

  discourse-2:
    build: ./services/discourse
    environment:
      - PORT=4002
      - DATABASE_URL=postgres://postgres:password@postgres-discourse:5432/discourse
      - INSTANCE_ID=discourse-2
    depends_on:
      - postgres-discourse
    networks:
      - capitalism-net

  discourse-3:
    build: ./services/discourse
    environment:
      - PORT=4003
      - DATABASE_URL=postgres://postgres:password@postgres-discourse:5432/discourse
      - INSTANCE_ID=discourse-3
    depends_on:
      - postgres-discourse
    networks:
      - capitalism-net

  mongo-marketplace:
    image: mongo:6
    volumes:
      - mongo-marketplace-data:/data/db
    networks:
      - capitalism-net

  postgres-discourse:
    image: postgres:15
    environment:
      - POSTGRES_DB=discourse
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres-discourse-data:/var/lib/postgresql/data
    networks:
      - capitalism-net

  redis:
    image: redis:7-alpine
    volumes:
      - redis-data:/data
    networks:
      - capitalism-net

  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - capitalism-net

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3004:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - grafana-data:/var/lib/grafana
    networks:
      - capitalism-net

networks:
  capitalism-net:
    driver: bridge

volumes:
  mongo-marketplace-data:
  postgres-discourse-data:
  redis-data:
  prometheus-data:
  grafana-data:
  simulation-data:
